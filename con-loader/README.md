[![license: MIT/Apache-2.0](https://img.shields.io/badge/license-MIT%2FApache--2.0-blue.svg)](LICENSE-MIT)
[![crates.io](https://img.shields.io/crates/v/con-loader.svg)](https://crates.io/crates/con-loader)
[![docs.rs](https://docs.rs/con-loader/badge.svg)](https://docs.rs/con-loader)

# con-loader

`con-loader` provides supporting code for the `con` crate, handling module building and loading on MacOS and Linux. End users shouldn't need to use this crate directly - it exists as a dependency of the `con` crate and crates generated by the [con-cli](https://crates.io/crates/con-cli) tool.

However, this is the right place to learn about environment variables that will impact the
behavior of con-loader at runtime:

* `CON_TARGET_DIR`: Set the build directory for hot-reloadable plugins. By default, plugins are built into `$HOME/.con-mods/{mod-name}` or `%USERPROFILE%\.con-mods\{mod-name}` on Windows.

* `CON_BUILD`: Set to "0" to disable automatic mod compilation. Defaults to "1".

* `CON_NOISY_BUILDS`: Set to "1" to pipe build output directly to stdout/stderr. By default, output is only shown if the build fails.

In production, you probably want `CON_AUTOMATIC_MOD_BUILD` to be set to zero, as your mods
should be pre-built, and put in the right place, next to the executable.

> **Warning**
> Make sure to build your mods with the `rubicon/import-globals` and `impl`
> features enabled, just like `con-loader` would do.
>
> See the [rubicon docs](https://crates.io/crates/rubicon) for more details: essentially, your
> mods need to refer to the same process-local and thread-local variables that your main app does,
> or stuff like tokio etc. will break.

That is, if your Cargo workspace looks like this:

```
workspace/
  Cargo.toml
  mods/
    mod-markdown/
    mod-clap/
    con-markdown/
    con-clap/
  app/
    Cargo.toml
    src/lib.rs etc.
```

Then `con-loader` expects a file hierarchy like this:

```
workspace/
  target/
    debug/
      app
      libmod_markdown.dylib
      libmod_clap.dylib
```

Except it doesn't actually need to be in `target/debug/` of anywhere — this could all be
in a container image under `/app` or whatever.

## ABI Safety

con-loader uses [rubicon](https://github.com/bearcove/rubicon) to ensure that the ABI of the
module matches the ABI of the app they're being loaded into — this is not the concern of the
"con" family of crates however.

If you mess something up, you should get a detailed panic with colors and emojis explaining
exactly what you got wrong.

Note that if you need crates like tokio, tracing, eyre, etc. you should use their
patched versions, see the [rubicon compatibility tracker](https://github.com/bearcove/rubicon/issues/3).
